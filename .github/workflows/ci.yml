name: ‚ôæÔ∏è Continuous Integration

on: [push, pull_request]

env:
  DENO_DIR: deno
  DENO_INSTALL_ROOT: deno-bin
  ENVIRONMENT: ${{ vars.ENVIRONMENT }}
  ADMIN_EMAILS: ${{ secrets.ADMIN_EMAILS }}
  ADMIN_PASSWORDS: ${{ secrets.ADMIN_PASSWORDS }}

jobs:
  setup:
    name: üõ†Ô∏è Setup Workflow
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: vx.x.x
      - name: Cache dependencies
        run: deno task cache:prod
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: app
          path: |
            ./
            !.git
  test:
    name: üß™ Run Tests
    needs: setup
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: app
      - name: Start MongoDB
        uses: MongoCamp/mongodb-github-action@1.2.0
      - name: Run tests with Deno
        run: deno test -A